
/* @jsx React.createElement */?????????????????????????????????????????????
const { useEffect, useMemo, useRef, useState } = React;?
// -------------------------------------------------??????????????????????????????????????????????
// Dark revert: default dark theme with a Light/Dark toggle??????????????????????????????????????
// -------------------------------------------------?
type ID = string;?
type Priority = 1 | 2 | 3 | 4 | 5; // 1=Lowest, 5=Highest??????????????????????????????????????????????????????????????


  id: ID;?????????????????
  done: boolean;??????????????????????
  difficulty: Difficulty;???????????????????????????
  estimatedMinutes?: number; // optional ETA in minutes??????????????????
  status?: Status;?????????????????????????????????????????????????
};?
type Task = {??????????
  title: string;??????????????????
  done: boolean;??????????????????????
  difficulty: Difficulty;???????????????????????????
  estimatedMinutes?: number; // optional ETA in minutes??????????????????
  status?: Status;?????????????????????????????
  steps: Step[];??????????????????????????????????????????????
};?
type Project = {??????????
  name: string;?????????????????
  deletedAt?: string;???
// Plan item can be a task or a step (with parent task title)???????????????????
  kind: "task" | "step";??????????
  score: number;?????????????????
  parentTaskId?: ID;????????????????????????????
  parentProjectId?: ID;??????????????????????????????
  dueDate?: string;??????????????????????
  difficulty: Difficulty;??????????????????
};?
// ----------------------?????????????
// ----------------------????????????????????????????????????
const SETTINGS_KEY = "projectcalm:settings";?????????????????????????????????????????????

  breathe: { inhale: number; hold1: number; exhale: number; hold2: number };???

  try {?????????????????????????????????????????
      const raw = localStorage.getItem(SETTINGS_KEY);?????????????????
        const parsed = JSON.parse(raw) as AppSettings;??????????????????????????????????????????????????????????????????????????????????
        return { breathe: {??????????????????????????????????????????????????????
          hold1: Math.max(1, Number(b.hold1) || 4),??????????????????????????????????????????????????????
          hold2: Math.max(1, Number(b.hold2) || 4),????????????
      }??????
  } catch {}????????????????????????????????????????????????????????????????????
}?
// ----------------------???????????????????????????????????
// ----------------------????????????????????????????????
  tab: "all" | "today" | "done" | "trash" | "plan";???????????????????????
  addProject: (name?: string) => void;????????????????????????????????????????????????????????????????????????
  addProjectStep: (projectId: ID, title: string) => void;???????????????????????????
    projectId: ID,????????????????
    meta: Partial<Pick<Step, "priority" | "difficulty" | "dueDate" | "title" | "status" | "estimatedMinutes">>?????????????
  toggleProjectStepDone: (projectId: ID, stepId: ID) => void;???????????????????????????????????????????????????????????????
  softDeleteProjectStep: (projectId: ID, stepId: ID) => void;???????????????????????????????????????????????????????????
  purgeProjectStep: (projectId: ID, stepId: ID) => void;?????????????????
  cardBase: string;????????????????????
  chipTone: string;??????????????????????
  btnDestructive: string;?????
  const {?????????
    projects,????????????????
    renameProject,????????????????????
    updateProjectStepMeta,???????????????????????????
    toggleProjectStepToday,???????????????????????????
    restoreProjectStep,??????????????????????
    cardBase,??????????????
    chipTone,????????????????
    btnDestructive,?????????????

    const name = window.prompt("New project name?") || "";???????????????????????????????
    if (!label) return;???????????????????????
  }?
  return (????????????????????????????????
      <div className={classNames(cardBase, cardTone)}>????????????????????????????????????????????????????????????
          <div className="font-semibold">Projects</div>??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
        </div>?????????????
      {projects.map((p) => (????????????????????????????????????????????????????????????????????
          <div className="flex items-center justify-between mb-3">??????????????????????????????????????????????????????????
            <div className="text-xs text-slate-400">???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
            </div>?????????????????
          <div className="flex items-center gap-2 mb-3">????????????????????
              className={classNames("px-2 py-1 rounded-lg border text-xs", btnNeutral)}???????????????????????????????
                const next = window.prompt(`Rename project "${p.name}" to:`, p.name);??????????????????????????????????????????????????????????????
              }}??????????????
              Rename Project??????????????????????
          </div>?????????????????????????????
            tab={tab}????????????????????????
            onAddStep={addProjectStep}?????????????????????????????????????????????????????
            onToggleStepToday={toggleProjectStepToday}?????????????????????????????????????????????????????
            onSoftDeleteStep={softDeleteProjectStep}???????????????????????????????????????????????
            onPurgeStep={purgeProjectStep}????????????????????????????????
            btnNeutral={btnNeutral}????????????????????????????????????????????
            cardBase={cardBase}????????????????????????????????
          />???????????????
      ))}???????????
  );??

  tab: "all" | "today" | "done" | "trash" | "plan";????????????????????
  onAddStep: (projectId: ID, title: string) => void;?????????????????????????????????????????????????????????
  onToggleStepToday: (projectId: ID, stepId: ID) => void;??????????????????????
    projectId: ID,????????????????
    meta: Partial<Pick<Step, "priority" | "difficulty" | "dueDate" | "title" | "status" | "estimatedMinutes">>?????????????
  onSoftDeleteStep: (projectId: ID, stepId: ID) => void;??????????????????????????????????????????????????????
  onPurgeStep: (projectId: ID, stepId: ID) => void;????????????????????
  btnNeutral: string;??????????????????????????
  cardBase: string;????????????????????
}) {????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  const [stepTitle, setStepTitle] = useState("");?????????????????????????????????????????????????????
    if (tab === 'trash') return !!s.deletedAt;???????????????????????????????????
    if (tab === 'today') return !!s.today && !s.done;?????????????????????????????????????????
    return true;??????
  return (???????????????????????????
      <div className="flex gap-2 mb-2">????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
        <button onClick={() => { onAddStep(project.id, stepTitle); setStepTitle(""); }} className={classNames("px-3 py-2 rounded-xl border", btnNeutral)}>Add Step</button>?????????????
      {visibleSteps.length === 0 ? (????????????????????????????????????????????????????????????????
      ) : (???????????????????????????????????
          {visibleSteps.map((s) => (?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
              <div className="flex items-start justify-between">??????????????????????????????????????????????????????
                  <div className="flex items-center gap-3 mb-1">?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
        <input className="font-medium w-full outline-none bg-transparent" value={s.title} onChange={(e) => onUpdateStepMeta(project.id, s.id, { title: e.target.value })} />?????????????????????????
                  <div className="flex flex-wrap items-center gap-2 mt-1 text-xs">?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                    <span className={classNames("px-2 py-1 rounded-full border", chipTone)}>D{chip(s.difficulty)} ?? {labelForDifficulty(s.difficulty)}</span>???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                    {(s.dueDate) && (() => { const du = daysUntil(s.dueDate); const tone = (du===undefined)?"" : (du < 0 ? "text-red-400" : du <= 5 ? "text-yellow-400" : "text-emerald-400"); return <span className={classNames("px-2 py-1 rounded-full border", chipTone, tone)}>{typeof du === 'number' ? `${du}` : ''}</span>; })()}?????????????????????????
                </div>????????????????????????????????????????????????????????????????
                  <div className="flex gap-2">??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                      {s.today ? "Remove from Today" : "Add to Today"}??????????????????????????????
                    <button onClick={() => onSoftDeleteStep(project.id, s.id)} className={classNames("px-3 py-1 rounded-lg border", btnDestructive)}>Delete</button>?????????????????????????
                  <div className="flex gap-2 text-xs">??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                      {[1, 2, 3, 4, 5].map((p) => (<option key={p} value={p}>P{p} ?? {labelForPriority(p as Priority)}</option>))}??????????????????????????????
                    <select className="border rounded-md px-2 py-1 bg-transparent" value={s.difficulty} onChange={(e) => onUpdateStepMeta(project.id, s.id, { difficulty: Number(e.target.value) as Difficulty })}>???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                    </select>?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                    <select className="border rounded-md px-2 py-1 bg-transparent" value={s.status ?? 'todo'} onChange={(e) => onUpdateStepMeta(project.id, s.id, { status: e.target.value as Status })}>??????????????????????????????????????????????????????????
                      <option value="in_progress">In Progress</option>???????????????????????????????????????????????????????????????
                      <option value="done">Done</option>??????????????????????????????
                  </div>???????????????????????
              </div>????????????????????????????????
                <div className="mt-2 text-xs text-slate-400">Deleted {new Date(s.deletedAt).toLocaleString()} ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                  <button className="ml-2 underline" onClick={() => purgeProjectStep(project.id, s.id)}>Delete forever</button>???????????????????????
              )}??????????????????
          ))}??????????????
      )}???????????
  );??
function getAppVersion(): string {????????
    if (typeof window !== "undefined" && (window as any).__APP_VERSION) {????????????????????????????????????????????????????
    }???????????????????????????????????????????
      const meta = document.querySelector('meta[name="app-version"]') as HTMLMetaElement | null;?????????????????????????????????????????????????????
    }?????????????
  return "vNext";??

  return Math.random().toString(36).slice(2) + Date.now().toString(36);??

  if (!date) return "";????????
    // Convert to local-date string for <input type="date"> to avoid off-by-one??????????????????????????????
    const local = new Date(d.getTime() - d.getTimezoneOffset() * 60000);?????????????????????????????????????????????
  } catch {???????????????
  }??

  if (!v) return undefined;?????????????????????????
  if (Number.isNaN(d.getTime())) return undefined;?????????????????????????????????????????????
  d.setHours(12, 0, 0, 0);??????????????????????????
}?
function daysUntil(d?: string): number | undefined {????????????????????????????
  const now = new Date();??????????????????????????????
  const ms = target.getTime() - now.getTime();?????????????????????????????????????????????????
}?
function scoreItem(??????????
    done: boolean;??????????????????????
    priority: Priority;????????????????????????????
    today: boolean;???????????????????????
    estimatedMinutes?: number;????
): number {??????????????????????????????
  let s = 0;?
  // Priority carries the biggest weight???????????????????????????????????
  const pr = 6 - opts.priority; // P1=>5, P5=>1??????????????????????????

  s -= opts.difficulty * 5; // -5..-25?
  // Urgency: closer due dates increase score??????????????????????
    const du = daysUntil(opts.dueDate);??????????????????????????????????
      // Due today: +25, Tomorrow: +23, In 30 days: ~0??????????????????????????????????????????????
      // Overdue gets a big boost???????????????????????????????????????????????????
    }????

  if (opts.today) s += 12;?
  // Completed or deleted plummet???????????????????????????
  if (opts.deleted) s -= 1000;?
  // Prefer shorter estimated items slightly???????????????????????????????????????????????????
    const est = Math.max(0, opts.estimatedMinutes);??????????????????????????????????????????????????????????????????????????????????
    s -= Math.min(15, (est / 60) * 5);????

}?
function classNames(...xs: Array<string | false | null | undefined>) {???????????????????????????????????????
}?
function chip(v: number) {?????????????????
}?
function labelForDifficulty(d: Difficulty) {??????????????????????????????????????????????????????????????????????
}?
function labelForPriority(p: Priority) {????????????????????????????????????????????????????????????????
}?
function labelForStatus(s?: Status) {???????????????
    case 'in_progress': return 'In Progress';??????????????????????????????????????
    case 'done': return 'Done';?????????????????????????????
  }??

  plan: PlanItem[];?????????????????
  projects: Project[];???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  toggleTaskDone: (id: ID) => void;?????????????????????????????????????
  updateStepMeta: (parentId: ID, stepId: ID, meta: Partial<Pick<Step, "priority" | "difficulty" | "dueDate" | "title" | "estimatedMinutes">>) => void;??????????????????????????????????????????????????????
  toggleStepToday: (parentId: ID, stepId: ID) => void;???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  toggleProjectStepToday: (projectId: ID, stepId: ID) => void;????????????????????????????????????????????????????????????????????????????????????????????
}) {??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  const taskById = useMemo(() => {???????????????????????????????????
    tasks.forEach((t) => m.set(t.id, t));??????????????
  }, [tasks]);??????????????????????????????????????
    const m = new Map<ID, Project>();?????????????????????????????????????????????????????
    return m;??????????????????
  const projectRecs = useMemo(() => computeProjectRecommendations(tasks, projects), [tasks, projects]);???????????
    <div className={classNames(cardBase, cardTone)}>???????????????????????????????????????????????????????????????
        <h3 className="font-semibold">AI Plan (Heuristic)</h3>?????????????
      <div className="mb-3">??????????????????????????????????????????????????????????????????????????????????
        {projectRecs.length === 0 ? (??????????????????????????????????????????????????????????????????????????????
        ) : (?????????????????????????????????????????????
            {projectRecs.map((p, idx) => (?????????????????????????????????????????????????????????????????????????????????
                <div className="truncate"><span className="text-slate-400 mr-2">#{idx+1}</span>{p.project}</div>??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
              </li>????????????????
          </ul>???????????
      </div>?????????????????????????????
        <p className="text-sm text-slate-400">No plan yet. Click "AI Plan".</p>????????????
        <ul className="space-y-2">?????????????????????????????????
            const isTask = it.kind === 'task';???????????????????????????????????????????????????????????????????????????
            const task = isTask ? taskById.get(it.id) : parent || null;????????????????????????????????????????????????????????????????????????????????????????????
            return (??????????????????????????????????????????????????????????????????????????????????????????????????
                <div className="flex items-start justify-between gap-3">???????????????????????????????????????????????????
                    <div className="text-sm text-slate-400">#{i + 1} ?? {isTask ? 'Task' : 'Step'}{it.parentTaskTitle ? ` ?? ${it.parentTaskTitle}` : ''}</div>????????????????????????????????????????
                      <div>???????????????????????????????????????????????????????????????????????
        <input className="font-medium w-full outline-none bg-transparent" value={task.title} onChange={(e) => updateTaskMeta(task.id, { title: e.target.value })} />???????????????????????????????
                        <div className="flex flex-wrap items-center gap-2 mt-1 text-xs">????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                          <span className={classNames("px-2 py-1 rounded-full border", chipTone)}>D{chip(task.difficulty)}</span>???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                          {task.dueDate && (() => { const du = daysUntil(task.dueDate); const tone = (du===undefined)?"" : (du < 0 ? "text-red-400" : du <= 5 ? "text-yellow-400" : "text-emerald-400"); return <span className={classNames("px-2 py-1 rounded-full border", chipTone, tone)}>{typeof du === 'number' ? `${du}` : ''}</span>; })()}????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                            {[1,2,3,4,5].map(p => <option key={p} value={p}>{`P${p}`}</option>)}????????????????????????????????????
                          <select className="border rounded-md px-2 py-1 bg-transparent" value={task.difficulty} onChange={(e) => updateTaskMeta(task.id, { difficulty: Number(e.target.value) as Difficulty })}>?????????????????????????????????????????????????????????????????????????????????????????????????
                          </select>???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                                 onChange={(e) => updateTaskMeta(task.id, { estimatedMinutes: e.target.value === '' ? undefined : Math.max(0, Number(e.target.value) || 0) })} />?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                        </div>?????????????????????????????
                    ) : step && parent ? (????????????????????????????
                        <div className="flex items-center gap-3 mb-1">????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                        </div>?????????????????????????????????????????????????????????????????????????????????????????
                          <span className={classNames("px-2 py-1 rounded-full border", chipTone)}>P{chip(step.priority)}</span>??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                          <span className={classNames("px-2 py-1 rounded-full border", chipTone)}>{step.dueDate ? `Due ${new Date(step.dueDate).toLocaleDateString()}` : "No due date"}</span>???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                          <select className="border rounded-md px-2 py-1 bg-transparent" value={step.priority} onChange={(e) => updateStepMeta(parent.id, step.id, { priority: Number(e.target.value) as Priority })}>?????????????????????????????????????????????????????????????????????????????????????????????????
                          </select>?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                            {[1,2,3,4,5].map(d => <option key={d} value={d}>{`D${d}`}</option>)}????????????????????????????????????
        <input type="number" min={0} className="w-24 border rounded-md px-2 py-1 bg-transparent" placeholder="Est. min" value={step.estimatedMinutes ?? '' as any}?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
        <input type="date" className="border rounded-md px-2 py-1 bg-transparent" value={toISODateInputValue(step.dueDate)} onChange={(e) => updateStepMeta(parent.id, step.id, { dueDate: fromISODateInputValue(e.target.value) })} />???????????????????????????????
                      </div>??????????????????????????
                      <div className="font-medium">{it.title}</div>???????????????????????
                  </div>??????????????????????????????????????????????????????????????????
                    <span className={classNames("text-xs px-2 py-1 rounded-full border", chipTone)}>Score {Math.round(it.score)}</span>????????????????????????????????????????
                      <button className={classNames("px-3 py-1 rounded-lg border", btnNeutral || "bg-transparent")} onClick={() => toggleTaskToday(task.id)}>????????????????????????????????????????????????????????????????????????????
                      </button>???????????????????????????????????????????
                      <button className={classNames("px-3 py-1 rounded-lg border", btnNeutral || "bg-transparent")} onClick={() => toggleStepToday(parent.id, step.id)}>????????????????????????????????????????????????????????????????????????????
                      </button>??????????????????????????????
                  </div>???????????????????????
              </li>???????????????
          })}??????????????
      )}?

  );??

// Demo seed (client-generated)??????????????????????????
function generateSeed(): Task[] {???????????
    {?????????????????
      title: "Design onboarding flow",????????????????????????????????????
      done: false,???????????????????
      difficulty: 3,??????????????????????????????????????????????????????????????????
      today: true,?????????????????????????????
      project: "Project Calm App",???????????????
        { id: uid(), title: "Sketch alternatives", done: false, priority: 3, difficulty: 2, dueDate: undefined, today: false, status: 'todo' },??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
      ],???????
    {?????????????????
      title: "Prep launch checklist",??????????????????????????
      done: false,???????????????????
      difficulty: 2,??????????????????????????????????????????????????????????????????
      today: false,??????????????????????
      project: "Release",???????????????
        { id: uid(), title: "Write release notes", done: false, priority: 4, difficulty: 2, dueDate: undefined, today: false, status: 'todo' },?????????
    },?????
}?
function createInitialTasks(): Task[] {????????????????????????????????????????????????
  const raw = localStorage.getItem(LS_KEY);?????????????
    try {????????????????????????????????????????????????
      return parsed.map((t) => ({??????????????
        status: t.status ?? (t.done ? 'done' : (t.today ? 'in_progress' : 'todo')),?????????????????????????????????????????
        steps: (t.steps || []).map((s) => ({????????????????
          status: s.status ?? (s.done ? 'done' : (s.today ? 'in_progress' : 'todo')),?????????????
      }));???????????????
  }????????????????????????????????
  try {???????????????????????????????????????????????????????????
    if (braw) {??????????????????????????????????
      if (b && Array.isArray(b.tasks)) return b.tasks as Task[];??????
  } catch {}?????????????????????????
}?
// ----------------------??????????????????????????????????????????????
// ----------------------????????????????????????????????????????????????????????????????????????
  const items: PlanItem[] = [];?????????????????????????
    const tScore = scoreItem({????????????????????
      dueDate: t.dueDate,????????????????????????????
      difficulty: t.difficulty,??????????????????????
      deleted: !!t.deletedAt,????????????????????????????????????????????
    });???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

      const effectiveDue = s.dueDate ?? t.dueDate; // unify scoring + display????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
      items.push({ kind: "step", id: s.id, score: sScore, title: s.title, parentTaskId: t.id, parentTaskTitle: t.title, dueDate: effectiveDue, priority: s.priority, difficulty: s.difficulty, today: s.today });????????
  });???????????????????????????????????????????
  // Include project steps????????
    (projects || []).forEach((p) => {???????????????????????????????????????
        if (s.deletedAt) return;??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
        items.push({ kind: "step", id: s.id, score: sScore, title: s.title, parentTaskTitle: p.name, dueDate: s.dueDate, priority: s.priority, difficulty: s.difficulty, today: s.today });??????????
    });?????????????????????????????????????????????
  } catch {}????????????????
}?
// Aggregate project recommendations based on plan items??????????????????????????????????????????????????????????????????????????????
  const byProject = new Map<string, { project: string; score: number; open: number; today: number; done: number }>();???????????????????????????
    const key = (t.project ?? 'General') || 'General';??????????????????????????????????????????????????????????????????????????????????????????????
    const tScore = scoreItem({ done: t.done, dueDate: t.dueDate, priority: t.priority, difficulty: t.difficulty, today: t.today, deleted: !!t.deletedAt, estimatedMinutes: t.estimatedMinutes });??????????????????????????????????????
    if (!t.deletedAt) {???????????????????????????????????????????????
      if (t.today) agg.today++;??????
    for (const s of t.steps) {?????????????????????????????????
      const effectiveDue = s.dueDate ?? t.dueDate;????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
      agg.score += Math.max(0, sScore) * 0.7; // steps contribute slightly less than tasks??????
    byProject.set(key, agg);????
  // Include projects registry steps????????
    (projects || []).forEach((p) => {??????????????????????????????????????????????????????????????????????????????????????????????????????
      (p.steps || []).forEach((s) => {??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
        agg.score += Math.max(0, sScore) * 0.7;????????????????????????????
          if (s.done) agg.done++; else agg.open++;????????????????????????????????????
        }??????????
      byProject.set(p.name, agg);????????
  } catch {}???????????????????????????????????????????????????????????????????????????
}?
// ----------------------?????????????
// ----------------------????????????????????????????
  const [tasks, setTasks] = useState<Task[]>(createInitialTasks);???????????????????????????????????????????????????????????????????????????
  const [tab, setTab] = useState<"all" | "today" | "done" | "trash" | "plan">("today");????????????????????????????????????????????????????
  const [projects, setProjects] = useState<Project[]>(() => {??????????
      if (typeof window === 'undefined') return [];??????????????????????????????????????????????????????
      if (raw) return JSON.parse(raw) as Project[];???????????????
    return [];??????

  const [dark, setDark] = useState(true);?
  // Breathe overlay state?????????????????????????????????????????????????????????
  const [breathingRunning, setBreathingRunning] = useState(false);?????????????????????????????????????????????????????????????????????????????????????
  const [secondsLeft, setSecondsLeft] = useState(4);????????????????????????????????????????????????
  const [settingsOpen, setSettingsOpen] = useState(false);?????????????????????????????????????????????????????????????????????????????????????????????????????
    const s = loadSettings().breathe;???????????????????????????????????????????????????
  });?
  useEffect(() => {???????????????????????????????????????????????
    setTasks((prev) => {????????????????????????????????????????
      const raw = localStorage.getItem(LS_KEY);?????????????????
        try {????????????????????????????????????????????????????
          return parsed.map((t) => ({ ...t, project: t.project ?? "General" }));???????????????????
      }?????????????????????????????
    });??????????

    if (typeof window === "undefined") return;????????????????????????????
      localStorage.setItem(LS_KEY, JSON.stringify(tasks));????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
      // Daily backup rotation (one key per day)????????????
        const day = new Date();?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
        localStorage.setItem(dayKey, JSON.stringify({ when: new Date().toISOString(), tasks }));?????????????????
    }???????????????

    try {???????????????????????????????????????????
        localStorage.setItem(PROJECTS_KEY, JSON.stringify(projects));????????
    } catch {}??????????????????

  useEffect(() => {??????????
      if (typeof navigator !== 'undefined' && (navigator as any).storage && (navigator.storage as any).persist) {??????????????????????????????????????????????????????????????
      }???????????????
  }, []);?
  useEffect(() => () => { if (timerRef.current) window.clearInterval(timerRef.current); }, []);????????????????????
    try {???????????????????????????????????????????
        const [inhale, hold1, exhale, hold2] = breatheDurations;???????????????????????????????????????????????????????????????????????????????????????????????????????????
      }???????????????
  }, [breatheDurations]);?
  // Derived collections???????????????????????????????????????????????????
  const todayTasks = useMemo(() => tasks.filter((t) => !t.deletedAt && !t.done && t.today), [tasks]);???????????????????????????????????????????????????????????????????????????????????????????????
  const allTasks = useMemo(() => tasks.filter((t) => !t.deletedAt), [tasks]);?????????????????????????????????????????????????????????????????????????????????????????
  const trashTasks = useMemo(() => tasks.filter((t) => !!t.deletedAt), [tasks]);?????????????????????????????????????
    const del: Array<{ step: Step; parent: Task }> = [];??????????????????????????????????????????????????????????????????????????????????????????????????????????
    return del;???????????????

  function toggleTaskToday(id: ID) { setTasks((xs) => xs.map((t) => (t.id === id ? { ...t, today: !t.today } : t))); }????????????????????????????????????
    setTasks((xs) => xs.map((t) => t.id === id ? { ...t, deletedAt: new Date().toISOString(), steps: t.steps.map((s) => (s.deletedAt || s.done ? s : { ...s, deletedAt: new Date().toISOString() })) } : t));????
  function restoreTask(id: ID) { setTasks((xs) => xs.map((t) => t.id === id ? { ...t, deletedAt: undefined, steps: t.steps.map((s) => ({ ...s, deletedAt: undefined })) } : t)); }??????????????????????????????????????????????????????????????????????????????????
  function addStep(parentId: ID, title: string) {???????????????????????????????
    setTasks((xs) => xs.map((t) => t.id === parentId ? { ...t, steps: [{ id: uid(), title: title.trim(), done: false, priority: t.priority, difficulty: t.difficulty, today: false, status: 'todo' }, ...t.steps] } : t));????
  function toggleStepDone(parentId: ID, stepId: ID) { setTasks((xs) => xs.map((t) => t.id === parentId ? { ...t, steps: t.steps.map((s) => (s.id === stepId ? { ...s, done: !s.done, status: !s.done ? 'done' : (s.status === 'done' ? 'todo' : s.status) } : s)) } : t)); }??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  function updateTaskMeta(id: ID, meta: Partial<Pick<Task, "priority" | "difficulty" | "dueDate" | "title" | "notes" | "project" | "status" | "estimatedMinutes">>) {?????????????????????????????????????
      if (t.id !== id) return t;??????????????????????????????????????????????
      if (meta.status) next.done = meta.status === 'done';???????????????????
    }));????
  function updateStepMeta(parentId: ID, stepId: ID, meta: Partial<Pick<Step, "priority" | "difficulty" | "dueDate" | "title" | "status" | "estimatedMinutes">>) {???????????????????????????????????????????????????????????????????????????????????????????
      if (s.id !== stepId) return s;??????????????????????????????????????????????
      if (meta.status) next.done = meta.status === 'done';???????????????????
    }) } : t));????
  function softDeleteStep(parentId: ID, stepId: ID) { setTasks((xs) => xs.map((t) => t.id === parentId ? { ...t, steps: t.steps.map((s) => (s.id === stepId ? { ...s, deletedAt: new Date().toISOString() } : s)) } : t)); }???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  function purgeStep(parentId: ID, stepId: ID) { setTasks((xs) => xs.map((t) => (t.id === parentId ? { ...t, steps: t.steps.filter((s) => s.id !== stepId) } : t))); }?
  // Add task and project rename helpers??????????????????????????????????????????????????????????????????????????????????????????????????
    const name = (title || "").trim();???????????????????????
    const t: Task = {?????????????????
      title: name,?????????????????
      done: !!opts?.done,???????????????????
      difficulty: 3,??????????????????????????
      today: !!opts?.today,????????????????????????????????????????????????????????????????????????????
      steps: [],??????????????????????????
    };??????????????????????????????????
  }?
  // Projects registry helpers???????????????????????????????????????
    const label = (name || '').trim();????????????????????????
    const p: Project = { id: uid(), name: label, steps: [] };?????????????????????????????????????
  }?????????????????????????????????????????????????????????????????????????
    const label = (nextName || '').trim();????????????????????????
    setProjects((ps) => ps.map((p) => (p.id === projectIdOrOldName || p.name === projectIdOrOldName) ? { ...p, name: label } : p));????
  function addProjectStep(projectId: ID, title: string) {????????????????????????????????????
    if (!t) return;????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  }??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
    setProjects((ps) => ps.map((p) => p.id === projectId ? { ...p, steps: p.steps.map((s) => {?????????????????????????????????????
      const next = { ...s, ...meta } as Step;???????????????????????????????????????????????????????????
      return next;????????????????
  }??????????????????????????????????????????????????????????????
    setProjects((ps) => ps.map((p) => p.id === projectId ? { ...p, steps: p.steps.map((s) => (s.id === stepId ? { ...s, done: !s.done, status: !s.done ? 'done' : (s.status === 'done' ? 'todo' : s.status) } : s)) } : p));????
  function toggleProjectStepToday(projectId: ID, stepId: ID) {?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  }??????????????????????????????????????????????????????????????
    setProjects((ps) => ps.map((p) => p.id === projectId ? { ...p, steps: p.steps.map((s) => (s.id === stepId ? { ...s, deletedAt: new Date().toISOString() } : s)) } : p));????
  function restoreProjectStep(projectId: ID, stepId: ID) {??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  }?????????????????????????????????????????????????????????
    setProjects((ps) => ps.map((p) => p.id === projectId ? { ...p, steps: p.steps.filter((s) => s.id !== stepId) } : p));????

  function buildPlan() {????????????????????????????????????????????
    try { console.log('AI Plan computed:', p.length, 'items'); } catch {}????????????????????????????????
  }?????????????????????????????????????????
    const idsToToggle: Array<{ kind: "task" | "step"; id: ID; parentTaskId?: ID }> = [];????????????????????????????????????????????????????????
      const it = plan[i];???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
    }????????????????????????????????????????????????????????????????????????????????????????????
    const stepKeys = new Set(idsToToggle.filter((z) => z.kind === "step").map((z) => `${z.parentTaskId}::${z.id}`));???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
    setTab("today");????

  const PHASES = ["Inhale", "Hold", "Exhale", "Hold"] as const;??????????????????????????????
    setPhaseIdx(0); setSecondsLeft(breatheDurations[0] || 4); setBreathingRunning(true);??????????????????????????????????????????????????????????????????
    timerRef.current = window.setInterval(() => {??????????????????????????????
        if (s > 1) return s - 1;?????????????????????????????
          const next = (p + 1) % 4;?????????????????????????????????????
          setSecondsLeft(breatheDurations[next] || 4);???????????????????????
        });????????????????????????????????????????????????????????????????????????????????
      });???????????????????????????????????
  }??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

  const pageCls = classNames(?????????????????????????????????????????????????????????????????????????
    "min-h-screen p-6"?????
  const cardBase = "rounded-2xl shadow p-4 border";?????????????????????????????????????????????????????????????????????????????????????????????
  const chipTone = dark ? "bg-slate-800 border-slate-700" : "bg-amber-50 border-amber-300";???????????????????????????????????????????????
  const btnNeutral = dark????????????????????????????????????????????????????????????????????????
    : "bg-amber-100 hover:bg-amber-200 border-amber-300 text-stone-900";??????????????????????????
    ? "bg-slate-100 text-slate-900 border-slate-100 hover:opacity-90"?????????????????????????????????????????????????????????????????????
  const btnDestructive = dark ? "border-red-500 text-red-300" : "border-red-300 text-red-600";??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  const tabIdle = btnNeutral;??????????????????????????????
    ? "bg-transparent text-slate-300 border-slate-700 hover:bg-slate-800"???????????????????????????????????????????????????????????????????????????

  // Backup/restore helpers??????????????????????????
    try {?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
      const blob = new Blob([payload], { type: 'application/json' });?????????????????????????????????????????????
      const a = document.createElement('a');???????????????????????????????????????????????????????????????????????????????
      a.href = url;???????????????????????????????????????????????????????
      document.body.appendChild(a);?????????????????
      document.body.removeChild(a);????????????????????????????????
    } catch (e) { try { console.error('Export failed', e); } catch {} }????
  function importDataFromFile(file: File) {?????????????????????????????????????
    reader.onload = () => {????????????
        const parsed = JSON.parse(String(reader.result || 'null')) as { tasks?: Task[] };?????????????????????????????????????????????????????
          setTasks(parsed.tasks as Task[]);???????????????????????????
        } else {?????????????????????????????????????????
        }????????????????????
        alert('Failed to import backup.');????????
    };?????????????????????????????
  }???????????????????????????????????
    try {?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
      if (navigator && (navigator as any).clipboard && (navigator as any).clipboard.writeText) {??????????????????????????????????????????????????????????????????????
          const ta = document.createElement('textarea');???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
        });???????????????
        const ta = document.createElement('textarea');?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
      }???????????????????????????????????????????????????????????????????????
    } catch (e) { try { console.error('Copy failed', e); } catch {} }????
  function listDailyBackups(): Array<{ key: string; when: string }> {??????????????????????????????????????????????????????????
    try {?????????????????????????????????????????????????????
      const prefix = `${LS_KEY}:backup:`;??????????????????????????????????????????????????????
        const k = localStorage.key(i) as string;?????????????????????????????????????????
          try {??????????????????????????????????????????????????????????????????????????
            if (parsed && parsed.when) arr.push({ key: k, when: parsed.when });?????????????????????
        }????????
      arr.sort((a,b) => b.key.localeCompare(a.key));???????????????
    return arr;????
  function restoreFromBackupKey(k: string) {??????????
      const raw = localStorage.getItem(k);????????????????????????????????????????????????????????
      const parsed = JSON.parse(raw);????????????????????????????????????????????????????????????????????????????????????????????????????????
    } catch { alert('Failed to restore backup.'); }????

  // UI????????????????????????????
  return (??????????????????????????????
      <div className="max-w-6xl mx-auto">???????????????????????
        <div className="flex items-center justify-between mb-6">??????????????????????????????????????????????????????
            <h1 className="text-3xl font-bold tracking-tight">Project Calm</h1>??????????????????????????????????????????????????????????????????????????????????????????????????????????????????
          </div>????????????????????????????????????????????????????
            {/* Theme toggle */}?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
              {dark ? "+??? Light" : "??? Dark"}??????????????????????
            <button onClick={buildPlan} className={classNames("px-4 py-2", btnBase, btnNeutral)} title="Analyze tasks and steps to recommend the next-best work">AI Plan</button>????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
            <button onClick={() => setSettingsOpen(true)} className={classNames("px-4 py-2", btnBase, btnNeutral)} title="Open settings">Settings</button>?????????????????
        </div>?
        {/* Primary nav ?? Projects / Tasks */}???????????????????????????????????????????????????????
          {([??????????????????????????????????????
            ["tasks", "Tasks"],??????????????????????????????????????????????
            <button????????????????????????
              onClick={() => setViewMode(key)}??????????????????????????????????????????????
              className={classNames("px-3 py-1.5 rounded-full border", viewMode === key ? tabSelected : tabPrimaryIdle)}??????????????
              {label}??????????????????????
          ))}?
          {/* Secondary filters */}????????????????????????????????????????????
            {([??????????????????????????????
              ["today", "Today"],????????????????????????????????
              ["trash", "Trash"],????????????????????????????????????????????????
              <button??????????????????????????
                onClick={() => setTab(key)}???????????????????????????????????????????????????????????????????????????????????????????????????????????????
              >????????????????????????
              </button>????????????????
          </div>???????????????

        {tab === "plan" ? (????????????????????????????
            plan={plan}??????????????????????????
            projects={projects}????????????????????????????????????????????
            toggleTaskDone={toggleTaskDone}??????????????????????????????????????????????
            updateStepMeta={updateStepMeta}????????????????????????????????????????????
            toggleStepToday={toggleStepToday}????????????????????????
            cardBase={cardBase}????????????????????????????????
            chipTone={chipTone}????????????????????????????????????
          />?????????????????????????????????????
          <TasksView??????????????????????
            allTasks={allTasks}????????????????????????????????????
            doneTasks={doneTasks}????????????????????????????????????
            trashSteps={trashSteps}????????????????????????????????????????????????????????????????????????????????????????????????????????????
            toggleTaskDone={toggleTaskDone}??????????????????????????????????????????????
            softDeleteTask={softDeleteTask}??????????????????????????????????????
            purgeTask={purgeTask}??????????????????????????????
            updateTaskMeta={updateTaskMeta}????????????????????????????????????????????
            toggleStepDone={toggleStepDone}??????????????????????????????????????????????
            softDeleteStep={softDeleteStep}??????????????????????????????????????
            purgeStep={purgeStep}????????????????????????
            cardBase={cardBase}????????????????????????????????
            chipTone={chipTone}????????????????????????????????????
            btnDestructive={btnDestructive}?????????????
        ) : (?????????????????????????
            projects={projects}????????????????????????????????????
            renameProject={renameProject}????????????????????????????????????????????
            updateProjectStepMeta={updateProjectStepMeta}??????????????????????????????????????????????????????????
            toggleProjectStepToday={toggleProjectStepToday}??????????????????????????????????????????????????????????
            restoreProjectStep={restoreProjectStep}????????????????????????????????????????????????
            dark={dark}????????????????????????????????
            cardTone={cardTone}????????????????????????????????
            btnNeutral={btnNeutral}????????????????????????????????????????????
          />???????????
      </div>?
      {/* Breathe Overlay */}????????????????????????
        <div className="fixed inset-0 bg-slate-900/70 backdrop-blur-sm flex items-center justify-center z-50">???????????????????????????????????????????????????????????????????????????????????????????????
            <div className="text-sm text-slate-400 mb-2">Box Breathing</div>??????????????????????????????????????????????????????????????????????????????
            <div className="text-6xl font-mono leading-none mb-6">{secondsLeft}</div>?????????????????????????????????????????????????????????????????? Hold for 4 ????????????????? Hold for 4</p>?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
            <button onClick={() => { setBreatheOpen(false); stopBreathing(); }} className={classNames("px-4 py-2 rounded-xl", btnPrimary)}>Done</button>??????????????????????????????????????????????????????????????????????????
              {!breathingRunning ? (???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
              ) : (?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
              )}???????????????????
          </div>???????????????
      )}?????????????????????????
        <div className="fixed inset-0 bg-slate-900/70 backdrop-blur-sm flex items-center justify-center z-50">???????????????????????????????????????????????????????????????????????????????????
            <div className="flex items-center justify-between mb-4">??????????????????????????????????????????????????????????????????
              <button onClick={() => setSettingsOpen(false)} className={classNames("px-3 py-1.5 rounded-lg border", btnNeutral)}>Close</button>???????????????????
            <div>??????????????????????????????????????????????????????????????????????????????????????????
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3">??????????????????????
                  <label className="block text-xs text-slate-400 mb-1">Inhale</label>?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                         onChange={(e) => setBreatheDurations(([_, b, c, d]) => [Math.max(1, Number(e.target.value) || 1), b, c, d])} />???????????????????????
                <div>??????????????????????????????????????????????????????????????????????????????????????
        <input type="number" min={1} max={120} className="w-full border rounded-md px-2 py-1 bg-transparent" value={breatheDurations[1]}?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                </div>??????????????????????
                  <label className="block text-xs text-slate-400 mb-1">Exhale</label>?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                         onChange={(e) => setBreatheDurations(([a, b, _, d]) => [a, b, Math.max(1, Number(e.target.value) || 1), d])} />???????????????????????
                <div>??????????????????????????????????????????????????????????????????????????????????????
        <input type="number" min={1} max={120} className="w-full border rounded-md px-2 py-1 bg-transparent" value={breatheDurations[3]}?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                </div>?????????????????????
              <div className="mt-4 flex gap-2">?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                <button className={classNames("px-3 py-1.5 rounded-lg border", btnPrimary)} onClick={() => setSettingsOpen(false)}>Save</button>?????????????????????

                <div className="text-sm font-medium mb-2">Backup & Restore</div>????????????????????????????????????????????????????????????????????????????
                  <button className={classNames("px-3 py-1.5 rounded-lg border", btnNeutral)} onClick={exportData}>Export to JSON</button>????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                  <label className={classNames("px-3 py-1.5 rounded-lg border cursor-pointer", btnNeutral)}>?????????????????????????????????????
        <input type="file" accept="application/json" className="hidden" onChange={(e) => { const f = e.target.files && e.target.files[0]; if (f) importDataFromFile(f); }} />???????????????????????????
                  <button className={classNames("px-3 py-1.5 rounded-lg border", btnNeutral)} onClick={() => {??????????????????????????
                      const raw = localStorage.getItem(`${LS_KEY}:backup`);?????????????????????????????????????????????????????????????????????????????
                      const parsed = JSON.parse(raw);????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                    } catch {}????????????????????????????????????????????????????????
                </div>???????????????????????????????????????
                  <div className="text-xs text-slate-400 mb-1">Daily backups</div>?????????????????????????????????????????????????????
                    {listDailyBackups().slice(0,7).map((b) => (?????????????????????????????????????????????????????????????????????????????????????
                        <span className="truncate mr-2">{b.key.replace(`${LS_KEY}:backup:`, '')} ?? {new Date(b.when).toLocaleString()}</span>?????????????????????????????????????????????????????
                          <button className={classNames("px-2 py-0.5 rounded border", btnNeutral)} onClick={() => restoreFromBackupKey(b.key)}>Restore</button>???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                        </div>????????????????????????????
                    ))}??????????????????????????????????????????????????????????
                      <li className="text-slate-400">No daily backups yet.</li>???????????????????????
                  </ul>???????????????????????
                <p className="mt-2 text-xs text-slate-400">Tip: Data is stored in this browser for this URL. Export or copy JSON to keep it across devices or ports.</p>?????????????????????
            </div>?????????????????
        </div>?????????
    </div>?????
}?
// ----------------------????????????
// ----------------------????????????????????????????
  tab: "all" | "today" | "done" | "trash" | "plan";????????????????????
  todayTasks: Task[];?????????????????????
  trashTasks: Task[];???????????????????????????????????????????????????
  addTask: (title: string, opts?: { today?: boolean; done?: boolean }) => void;????????????????????????????????????
  toggleTaskToday: (id: ID) => void;????????????????????????????????????
  restoreTask: (id: ID) => void;???????????????????????????????
  addStep: (parentId: ID, title: string) => void;????????????????????
    id: ID,????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  ) => void;????????????????????
    parentId: ID,????????????????
    meta: Partial<Pick<Step, "priority" | "difficulty" | "dueDate" | "title">>?????????????
  toggleStepDone: (parentId: ID, stepId: ID) => void;???????????????????????????????????????????????????????
  softDeleteStep: (parentId: ID, stepId: ID) => void;???????????????????????????????????????????????????
  purgeStep: (parentId: ID, stepId: ID) => void;?????????????????
  cardBase: string;????????????????????
  chipTone: string;??????????????????????
  btnDestructive: string;?????
  const {?????????
    allTasks,????????????????
    doneTasks,????????????????
    trashSteps,?????????????
    toggleTaskDone,?????????????????????
    softDeleteTask,?????????????????
    purgeTask,?????????????
    updateTaskMeta,????????????????????
    toggleStepDone,?????????????????????
    softDeleteStep,?????????????????
    purgeStep,??????????
    cardBase,??????????????
    chipTone,????????????????
    btnDestructive,?????????????

    return (?????????????????
        trashTasks={trashTasks}????????????????????????????????
        restoreTask={restoreTask}??????????????????????????????
        restoreStep={restoreStep}??????????????????????????????
        cardBase={cardBase}????????????????????????????
      />???????
  }?
  const working = tab === "all" ? allTasks : tab === "today" ? todayTasks : doneTasks;?
  const [newTitle, setNewTitle] = useState("");?????????????????????????????
    const v = newTitle.trim();????????????????????
    addTask(v, { today: tab === "today", done: tab === "done" });?????????????????????
  }?
  return (????????????????????????????????
      <div className={classNames(cardBase, cardTone)}>?????????????????????????????????????
        <input className="border rounded-xl px-3 py-2 flex-1 bg-transparent" placeholder="Add a task" value={newTitle} onChange={(e) => setNewTitle(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter') submitNewTask(); }} />??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
        </div>?????????????
      <TaskList????????????????????????
        showSteps={false}??????????????????????????????????????
        onToggleToday={toggleTaskToday}??????????????????????????????????????
        onAddStep={addStep}??????????????????????????????????????????
        onUpdateStepMeta={updateStepMeta}??????????????????????????????????????????
        onToggleStepToday={toggleStepToday}??????????????????????????????????????????
        dark={dark}????????????????????????????
        cardTone={cardTone}????????????????????????????
        btnNeutral={btnNeutral}????????????????????????????????????????
      />???????????
  );??

  tab: "all" | "today" | "done" | "trash" | "plan";?????????????????
  allTasks: Task[];??????????????????????
  doneTasks: Task[];??????????????????????
  trashSteps: Array<{ step: Step; parent: Task }>;??????????????????????????????????????????????????????????????????????????????????????????????????
  renameProject: (oldName: string, newName: string) => void;????????????????????
    id: ID,????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  ) => void;????????????????????????????????????
  toggleTaskToday: (id: ID) => void;??????????????????????????????????????????????????
  updateStepMeta: (??????????????????
    stepId: ID,???????????????????????????????????????????????????????????????????????????????
  ) => void;??????????????????????????????????????????????????????
  toggleStepToday: (parentId: ID, stepId: ID) => void;????????????????????????????????????
  softDeleteStep: (parentId: ID, stepId: ID) => void;?????????????????????????????????
  restoreStep: (parentId: ID, stepId: ID) => void;???????????????????????????????
  purgeStep: (parentId: ID, stepId: ID) => void;?????????????????
  cardBase: string;????????????????????
  chipTone: string;??????????????????????
  btnDestructive: string;?????
  const {?????????
    tasks,??????????????
    todayTasks,???????????????
    trashTasks,????????????????
    addTask,???????????????????
    updateTaskMeta,????????????????????
    toggleTaskToday,?????????????
    updateStepMeta,????????????????????
    toggleStepToday,????????????????????
    softDeleteStep,?????????????????
    restoreStep,???????????????
    purgeStep,??????????
    cardBase,??????????????
    chipTone,????????????????
    btnDestructive,?????????????

    return (?????????????????
        trashTasks={trashTasks}????????????????????????????????
        restoreTask={restoreTask}??????????????????????????????
        restoreStep={restoreStep}??????????????????????????????
        cardBase={cardBase}????????????????????????????
      />???????
  }?
  // Dataset selection for grouping???????????????????????????????????????????????????????????????????????????????????????

  const groups = new Map<string, Task[]>();?????????????????????????????
    const key = t.project ?? "General";???????????????????????????????????????????????
    groups.get(key)!.push(t);????


    const name = window.prompt("New project name?") || "";???????????????????????????????
    if (!label) return;????????????????????????????????????????????????????????????????
    addTask("New task", { today: tab === 'today', done: tab === 'done' });????

    <div className="space-y-6">???????????????????????????????????????????????????????
        <div className="flex items-center justify-between">????????????????????????????????????????????????????????
          <button className={classNames("px-3 py-1.5 rounded-lg border", btnNeutral)} onClick={onAddProject}>Add Project</button>???????????????
      </div>??????????????????????????????????????????
        <div key={project} className={classNames(cardBase, cardTone)}>???????????????????????????????????????????????????????????????????
            <div className="font-semibold">{project}</div>?????????????????????????????????????????????????????
              {list.filter((t) => !t.done).length} open ??????????????????????????????????????????????? {list.filter((t) => t.done).length} done???????????????????
          </div>?????????????????????????????????????????????????????????
            <button????????????????????????????????????????????????????????????????????????????????????????
              onClick={() => {????????????????????????????????????????????????????????????????????????????????????????
                if (next !== null) renameProject(project, next);?????????????????
            >?????????????????????????????
            </button>?????????????????
          <TaskList?????????????????????????
            showSteps={true}??????????????????????????????????????????
            onToggleToday={toggleTaskToday}??????????????????????????????????????????
            onAddStep={addStep}??????????????????????????????????????????????
            onUpdateStepMeta={updateStepMeta}??????????????????????????????????????????????
            onToggleStepToday={toggleStepToday}??????????????????????????????????????????????
            dark={dark}????????????????????????????????
            cardTone={cardTone}????????????????????????????????
            btnNeutral={btnNeutral}????????????????????????????????????????????
          />???????????????
      ))}???????????
  );??

  plan: PlanItem[];??????????????????????????
  tasks: Task[];??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  toggleTaskDone: (id: ID) => void;?????????????????????????????????????
  updateStepMeta: (parentId: ID, stepId: ID, meta: Partial<Pick<Step, "priority" | "difficulty" | "dueDate" | "title">>) => void;??????????????????????????????????????????????????????
  toggleStepToday: (parentId: ID, stepId: ID) => void;????????????????????????????????????????????????????????????????????????????????????????????
}) {?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  const taskById = useMemo(() => {???????????????????????????????????
    tasks.forEach((t) => m.set(t.id, t));??????????????
  }, [tasks]);???????????
    <div className={classNames(cardBase, cardTone)}>???????????????????????????????????????????????????????????????
        <h3 className="font-semibold">AI Plan (Heuristic)</h3>??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
      </div>?????????????????????????????
        <p className="text-sm text-slate-400">No plan yet. Click "AI Plan".</p>????????????
        <ul className="space-y-2">?????????????????????????????????
            <li key={`${it.kind}-${it.id}`} className="border rounded-xl p-3 border-slate-700">??????????????????????????????????????????????????????????????????
                <div>?????????????????????????????????????????????????????????????????????????
                  <div className="font-medium">???????????????????????????????????????????????????????????????????????
                    {it.parentTaskTitle && <span className="text-slate-400"> ???????????????????????????????
                  </div>?????????????????????????????????????????????????????????????????????????????????????? D{chip(it.difficulty)} ????????????????????????????????????????????????????????????????????????????????? Score {Math.round(it.score)}</div>???????????????????????
                <div>?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                </div>?????????????????????
            </li>??????????????
        </ul>?????????
    </div>?????
}?
// ----------------------??????????????????
// ----------------------???????????????????????????
  tasks: Task[];??????????????????????
  onToggleDone: (id: ID) => void;???????????????????????????????????
  onSoftDelete: (id: ID) => void;????????????????????????????????????????????????????
  onUpdateTaskMeta: (????????????
    meta: Partial<Pick<Task, "priority" | "difficulty" | "dueDate" | "title" | "notes" | "project">>?????????????
  onUpdateStepMeta: (??????????????????
    stepId: ID,???????????????????????????????????????????????????????????????????????????????
  ) => void;????????????????????????????????????????????????????????
  onToggleStepToday: (parentId: ID, stepId: ID) => void;????????????????????????????????????????????????????????
  dark: boolean;????????????????????
  cardTone: string;????????????????????
  btnNeutral: string;??????????????????????????
}) {??????????
    showSteps,???????????
    onToggleDone,???????????????????
    onSoftDelete,???????????????
    onUpdateTaskMeta,??????????????????????
    onToggleStepDone,???????????????????????
    onSoftDeleteStep,??????????
    cardBase,??????????????
    chipTone,????????????????
    btnDestructive,?????????????


    <div className="space-y-4">??????????????????????????
        <div key={t.id} className={classNames(cardBase, cardTone)}>?????????????????????????????????????????????????????????????
          <>???????????????????????????????????????????????????????????????
              <div className="flex-1 min-w-0 pr-3">???????????????????????????????????????????????????????????????
        <input type="checkbox" checked={t.done} onChange={() => onToggleDone(t.id)} className="w-4 h-4" title="Mark done" />???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                </div>????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

                  ???????????????????????????????????????????????????????????????????????????????????????????????????????????????? {labelForPriority(t.priority)}</span>?????????????????????????????????????????????????????????????????????????????????????????????????????????????????? {labelForDifficulty(t.difficulty)}</span>?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                </div>?????????????????????

                <div className="flex gap-2">??????????????????????????
                    onClick={() => onToggleToday(t.id)}?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                  >?????????????????????????????????????????????????????????????????????
                  </button>????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                    Delete????????????????????????????
                </div>????????????????????????????????????????????????????????????????????????????
                  <select className="border rounded-md px-2 py-1 bg-transparent" value={t.priority} onChange={(e) => onUpdateTaskMeta(t.id, { priority: Number(e.target.value) as Priority })}>??????????????????????????????????????????????????
                      <option key={p} value={p}>??????????????????????????????????????????????????????????????????
                      </option>????????????????????????
                  </select>??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                    {[1, 2, 3, 4, 5].map((d) => (?????????????????????????????????????????????????
                        D{d} ?? {labelForDifficulty(d as Difficulty)}????????????????????????????????
                    ))}????????????????????????????
        <input type="date" className="border rounded-md px-2 py-1 bg-transparent" value={toISODateInputValue(t.dueDate)} onChange={(e) => onUpdateTaskMeta(t.id, { dueDate: fromISODateInputValue(e.target.value) })} />??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
        <input type="number" min={0} className="w-28 border rounded-md px-2 py-1 bg-transparent" placeholder="Est. min" value={t.estimatedMinutes ?? '' as any} onChange={(e) => onUpdateTaskMeta(t.id, { estimatedMinutes: e.target.value === '' ? undefined : Math.max(0, Number(e.target.value) || 0) })} />????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                    <option value="todo">To Do</option>?????????????????????????????????????????????????????????????????????
                    <option value="blocked">Waiting</option>???????????????????????????????????????????????????????
                  </select>???????????????????????
              </div>???????????????????

            {showSteps && (??????????????????????????
                task={t}??????????????????????????????????????
                onToggleStepDone={onToggleStepDone}??????????????????????????????????????????????????????
                onUpdateStepMeta={onUpdateStepMeta}????????????????????????????????????????????????????
                chipTone={chipTone}????????????????????????????????????????
                btnDestructive={btnDestructive}????????????????????????????????????
                cardTone={cardTone}?????????????????
            )}??????????????
        </div>??????????
    </div>?????
}?
function StepsBlock(props: {??????????????
  onAddStep: (parentId: ID, title: string) => void;????????????????????????????????????????????????????????
  onToggleStepToday: (parentId: ID, stepId: ID) => void;??????????????????????
    parentId: ID,????????????????
    meta: Partial<Pick<Step, "priority" | "difficulty" | "dueDate" | "title">>?????????????
  onSoftDeleteStep: (parentId: ID, stepId: ID) => void;????????????????????
  btnNeutral: string;??????????????????????????
  cardBase: string;????????????????????
}) {????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  const [stepTitle, setStepTitle] = useState("");?
  const visibleSteps = task.steps.filter((s) => !s.deletedAt);?
  return (???????????????????????????
      <div className="flex gap-2 mb-2">?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
        <button onClick={() => { onAddStep(task.id, stepTitle); setStepTitle(""); }} className={classNames("px-3 py-2 rounded-xl border", btnNeutral)}>Add Step</button>?????????????

        <p className="text-sm text-slate-400">No steps yet.</p>????????????
        <ul className="space-y-2">?????????????????????????????????????
            <li key={s.id} className={classNames("border rounded-xl p-3", cardTone.replace("bg-", "").replace(" ", " ") , "border-slate-700") }>?????????????????????????????????????????????????????????????????
                <div className="flex-1 min-w-0 pr-3">?????????????????????????????????????????????????????????????????
        <input className="font-medium w-full outline-none bg-transparent" value={s.title} onChange={(e) => onUpdateStepMeta(task.id, s.id, { title: e.target.value })} />?????????????????????????
                  <div className="flex flex-wrap items-center gap-2 mt-1 text-xs">?????????????????????????????????????????????????????????????????????????????????????????????????????????????????? {labelForPriority(s.priority)}</span>???????????????????????????????????????????????????????????????????????????????????????????????????????????????????? {labelForDifficulty(s.difficulty)}</span>???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                  </div>???????????????????????

                  <div className="flex gap-2">???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                      {s.today ? "Remove from Today" : "Add to Today"}??????????????????????????????
                    <button onClick={() => onSoftDeleteStep(task.id, s.id)} className={classNames("px-3 py-1 rounded-lg border", btnDestructive)}>Delete</button>?????????????????????????
                  <div className="flex gap-2 text-xs">???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                      {[1, 2, 3, 4, 5].map((p) => (<option key={p} value={p}>P{p} ?? {labelForPriority(p as Priority)}</option>))}??????????????????????????????
                    <select className="border rounded-md px-2 py-1 bg-transparent" value={s.difficulty} onChange={(e) => onUpdateStepMeta(task.id, s.id, { difficulty: Number(e.target.value) as Difficulty })}>???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                    </select>??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                    <select className="border rounded-md px-2 py-1 bg-transparent" value={s.status ?? 'todo'} onChange={(e) => onUpdateStepMeta(task.id, s.id, { status: e.target.value as Status })}>??????????????????????????????????????????????????????????
                      <option value="in_progress">In Progress</option>???????????????????????????????????????????????????????????????
                      <option value="done">Done</option>??????????????????????????????
                  </div>???????????????????????
              </div>??????????????????
          ))}??????????????
      )}???????????
  );??

// Trash view??????????????????????????
function TrashView(props: {??????????????????????
  trashSteps: Array<{ step: Step; parent: Task }>;?????????????????????????????????
  purgeTask: (id: ID) => void;???????????????????????????????????????????????????
  purgeStep: (parentId: ID, stepId: ID) => void;????????????????????
  cardTone: string;?????
  const { trashTasks, trashSteps, restoreTask, purgeTask, restoreStep, purgeStep, cardBase, cardTone } = props;???????????
    <div className="grid md:grid-cols-2 gap-4">???????????????????????????????????????????????????????
        <h3 className="font-semibold mb-3">Deleted Tasks</h3>?????????????????????????????????????????????????????????????????????????????????????????????????
        <ul className="space-y-3">???????????????????????????????????
            <li key={t.id} className="border rounded-xl p-3 flex items-center justify-between border-slate-700">????????????????????
                <div className="font-medium">{t.title}</div>????????????????????????????????????????????????????????????????????????????????????????????????????????????????
              </div>???????????????????????????????????????????
                <button className="px-3 py-1 rounded-lg border bg-transparent" onClick={() => restoreTask(t.id)}>Restore</button>????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
              </div>??????????????????
          ))}??????????????
      </div>???????????????????????????????????????????????????????
        <h3 className="font-semibold mb-3">Deleted Steps</h3>?????????????????????????????????????????????????????????????????????????????????????????????????
        <ul className="space-y-3">??????????????????????????????????????????????????
            <li key={step.id} className="border rounded-xl p-3 flex items-center justify-between border-slate-700">????????????????????
                <div className="font-medium">{step.title}</div>????????????????????????????????????????????????????????????????????????????? Deleted {new Date(step.deletedAt!).toLocaleString()}</div>?????????????????????
              <div className="flex gap-2">????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                <button className="px-3 py-1 rounded-lg border border-red-500 text-red-300" onClick={() => purgeStep(parent.id, step.id)}>Delete forever</button>?????????????????????
            </li>??????????????
        </ul>?????????????
    </div>?????
}?
// ----------------------???????????????????????????????????????
// ----------------------???????????????????????????
  const base = { done: false, dueDate: undefined as string | undefined, today: false, deleted: false };????????????????????????????????????????????????????????????????????????????????????????????
  const sP5 = scoreItem({ ...base, priority: 5 as Priority, difficulty: 3 as Difficulty });???????????????????????????????????????????????????????????????????????????????

  const sHard = scoreItem({ ...base, priority: 3 as Priority, difficulty: 5 as Difficulty });??????????????????????????????????????????????????????????????

  const du = daysUntil(oneDayAhead)!;?????????????????????????????????????????????????????????????????????????

  console.assert(fromISODateInputValue("") === undefined, "fromISODateInputValue empty string failed");?
  const sToday = scoreItem({ ...base, priority: 3 as Priority, difficulty: 3 as Difficulty, today: true });????????????????????????????????????????????????????????????????????????????????????????????????????????????????
  console.assert(sToday > sNotToday, "Today boost failed");?
  const t: Task = { id: "t1", title: "Parent", notes: "", done: false, priority: 3, difficulty: 2, dueDate: new Date(Date.now() + 3 * 86400000).toISOString(), today: false, steps: [ { id: "s1", title: "Child", done: false, priority: 3, difficulty: 2, today: false } ], project: "Test" };?????????????????????????????????
  const stepItem = plan.find((p) => p.kind === "step" && p.id === "s1")!;??????????????????????????????????????????????????????????????????????????????????????????????????????????????????
}?
try { if (typeof window !== "undefined") { setTimeout(__devRunTests, 0); } } catch {}?
// Expose component globally for non-module usage??????
  if (typeof window !== "undefined") {????????????????????????????????????????????
    window.__PCALM_SCRIPT_LOADED = true;??????????????????????????????????????????????????????????????????????
  }???????????






